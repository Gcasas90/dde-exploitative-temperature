open_sem()
{
    ## Create a semaphore to have $1 processes running in parallel at all times
    mkfifo pipe-$$
    exec 3<>pipe-$$
    rm pipe-$$
    local i=$1
    for((;i>0;i--)); do
        printf %s 000 >&3
    done
}
run_with_lock()
{
    ## Add a task to the semaphore
    local x
    read -u 3 -n 3 x && ((0==x)) || exit $x
    (
    "$@" 
    printf '%.3d' $? >&3
    )&
}

## Directory where the repository is donwloaded
DIR=~/exploitative-competition/

expl_comp()
{
    python ${DIR}expl-comp-sim.py \
	   -p ${DIR}parameters/${PARFILE}.json \
	   -v $2 \
	   -n $1 \
	   -o $3 \
	   -i $4 \
	   -b 6 \
	   -q
}

N=10
open_sem $N

## File containing the system parameters
PARFILE=greenplant-peristenus-highRstar
## File containing variable parameters
FILELIST=(greenplant-peristenus-highRstar-Topta2-sa2)
## Number of parameter combinations
NJOBSLIST=(525)
## Initial conditions
INITLIST=(inv2)

for I in 0
do
    FILE=${FILELIST[$I]}
    NJOBS=${NJOBSLIST[$I]}
    INIT=${INITLIST[$I]}
    
    VARFILE=${DIR}parameters/${FILE}.json
    ${DIR}python/expl-comp-parsummary.py -v $VARFILE
    
    OUTDIR=${DIR}data/${FILE}/
    OUTFILE=${OUTDIR}${PARFILE}-${INIT}

    if ! [[ -d ${OUTDIR} ]]
    then
	echo "${OUTDIR} not found, creating directory"
	mkdir -p ${OUTDIR}
    fi

    JOBSEQ=$(seq 0 $((${NJOBS}-1)))

    for job in ${JOBSEQ}
    do
	run_with_lock expl_comp $job $VARFILE $OUTFILE $INIT
    done
done
